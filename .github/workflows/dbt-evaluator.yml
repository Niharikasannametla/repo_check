
name: Run dbt Cloud Jobs

on:
  pull_request:
    branches:
      - main

jobs:
  run-dbt-cloud-jobs:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # STEP 1: Trigger FIRST dbt Cloud Job (check_eval)
      # -------------------------------
      - name: Trigger FIRST dbt Cloud Job (check_eval)
        run: |
          set -eo pipefail
          JOB1_ID=175956220197126
          ACCOUNT_ID=175956220182596
          API_TOKEN=${{ secrets.DBT_CLOUD_API_TOKEN }}

          echo "Triggering FIRST dbt Cloud job (check_eval)..."
          response=$(curl -s -X POST \
            -H "Authorization: Token $API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"cause\": \"Triggered by GitHub PR\", \"git_sha\": \"${{ github.event.pull_request.head.sha }}\"}" \
            "https://fa321.eu2.dbt.com/api/v2/accounts/$ACCOUNT_ID/jobs/$JOB1_ID/run/")

          run_id=$(echo "$response" | jq -r '.data.id')
          if [[ -z "$run_id" || "$run_id" == "null" ]]; then
            echo "‚ùå Failed to trigger FIRST dbt Cloud job (check_eval)."
            exit 1
          fi

          echo "run_id_job1=$run_id" >> $GITHUB_ENV

      # ----------------------------------------
      # STEP 2: Wait for FIRST dbt Cloud Job (check_eval) - Do NOT exit
      # ----------------------------------------
      - name: Wait for FIRST dbt Cloud Job (check_eval)
        continue-on-error: true
        run: |
          run_id="${{ env.run_id_job1 }}"
          ACCOUNT_ID=175956220182596
          API_TOKEN=${{ secrets.DBT_CLOUD_API_TOKEN }}
          job1_failed=false

          echo "Polling FIRST dbt Cloud job (check_eval)..."
          start_time=$(date +%s)
          timeout=1800

          while true; do
            status_code=$(curl -s -X GET \
              -H "Authorization: Token $API_TOKEN" \
              "https://fa321.eu2.dbt.com/api/v2/accounts/$ACCOUNT_ID/runs/$run_id/" | jq -r '.data.status')

            if [[ "$status_code" == "10" ]]; then
              echo "‚úÖ check_eval completed successfully."
              break
            elif [[ "$status_code" == "20" || "$status_code" == "30" ]]; then
              echo "‚ùå check_eval failed or cancelled."
              job1_failed=true
              break
            fi

            if (( $(date +%s) - start_time > timeout )); then
              echo "‚è± Timeout reached for check_eval."
              job1_failed=true
              break
            fi
            sleep 15
          done

          echo "job1_failed=$job1_failed" >> $GITHUB_ENV

      # ----------------------------------------
      # STEP 3: Monitor SECOND dbt Cloud Job (check_eval_add)
      # ----------------------------------------
      - name: Wait for SECOND dbt Cloud Job (check_eval_add)
        run: |
          JOB2_ID=175956220197685
          ACCOUNT_ID=175956220182596
          API_TOKEN=${{ secrets.DBT_CLOUD_API_TOKEN }}
          job2_failed=false

          echo "Polling SECOND dbt Cloud job (check_eval_add)..."
          start_time=$(date +%s)
          timeout=1800

          while true; do
            status_code=$(curl -s -X GET \
              -H "Authorization: Token $API_TOKEN" \
              "https://fa321.eu2.dbt.com/api/v2/accounts/$ACCOUNT_ID/runs/?job_definition_id=$JOB2_ID&order_by=-id&limit=1" | jq -r '.data[0].status')

            if [[ "$status_code" == "10" ]]; then
              echo "‚úÖ check_eval_add completed successfully."
              break
            elif [[ "$status_code" == "20" || "$status_code" == "30" ]]; then
              echo "‚ùå check_eval_add failed or cancelled."
              job2_failed=true
              break
            fi

            if (( $(date +%s) - start_time > timeout )); then
              echo "‚è± Timeout reached for check_eval_add."
              job2_failed=true
              break
            fi
            sleep 15
          done

          echo "job2_failed=$job2_failed" >> $GITHUB_ENV

      # ----------------------------------------
      # STEP 4: Final Status Check
      # ----------------------------------------
      - name: Final Status Check
        run: |
          job1_failed="${{ env.job1_failed }}"
          job2_failed="${{ env.job2_failed }}"
          success_jobs=""
          failed_jobs=""

          if [[ "$job1_failed" == "true" ]]; then
            failed_jobs="check_eval (ID:175956220197126)"
          else
            success_jobs="check_eval (ID:175956220197126)"
          fi

          if [[ "$job2_failed" == "true" ]]; then
            if [[ -n "$failed_jobs" ]]; then
              failed_jobs="$failed_jobs and check_eval_add (ID:175956220197685)"
            else
              failed_jobs="check_eval_add (ID:175956220197685)"
            fi
          else
            if [[ -n "$success_jobs" ]]; then
              success_jobs="$success_jobs and check_eval_add (ID:175956220197685)"
            else
              success_jobs="check_eval_add (ID:175956220197685)"
            fi
          fi

          echo "‚úÖ Successful Jobs: $success_jobs"
          if [[ -n "$failed_jobs" ]]; then
            echo "‚ùå Failed Jobs: $failed_jobs"
            exit 1
          else
            echo "üéâ All dbt Cloud jobs completed successfully."
          fi
