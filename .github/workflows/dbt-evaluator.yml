
name: Run dbt Cloud Job

# Trigger workflow on pull requests targeting the main branch
# (You can change this to 'develop' if needed)
on:
  pull_request:
    branches:
      - main

jobs:
  run-dbt-cloud-job:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # STEP 1: Trigger dbt Cloud Job
      # -------------------------------
      - name: Trigger dbt Cloud Job
        id: trigger
        run: |
          set -eo pipefail  # Exit on error and fail on pipe errors

          echo "Triggering dbt Cloud job..."

          # Make POST request to dbt Cloud API to start the job
          # Use PR's head commit SHA (source branch) instead of merge commit
          response=$(curl -s -X POST \
            -H "Authorization: Token ${{ secrets.DBT_CLOUD_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"cause\": \"Triggered by GitHub PR\", \"git_sha\": \"${{ github.event.pull_request.head.sha }}\"}" \
            https://fa321.eu2.dbt.com/api/v2/accounts/175956220182596/jobs/175956220197126/run/)

          # Extract run_id from API response
          run_id=$(echo "$response" | jq -r '.data.id')

          # Validate run_id
          if [[ -z "$run_id" || "$run_id" == "null" ]]; then
            echo "❌ Failed to trigger dbt Cloud job. Response:"
            echo "$response"
            exit 1
          fi

          # Save run_id to GitHub environment for next step
          echo "run_id=$run_id" >> $GITHUB_ENV

          # Print dbt Cloud run URL for easy access
          echo "Run URL: https://fa321.eu2.dbt.com/account/175956220182596/runs/$run_id"

      # ----------------------------------------
      # STEP 2: Wait for dbt Cloud Job to finish
      # ----------------------------------------
      - name: Wait for dbt Cloud Job to finish
        run: |
          set -eo pipefail

          run_id="${{ env.run_id }}"
          echo "Polling dbt Cloud job status for run_id=$run_id..."

          # Timeout after 30 minutes to avoid infinite loop
          start_time=$(date +%s)
          timeout=1800  # 30 minutes
          status_code=""

          # Poll until job reaches a terminal state
          while true; do
            # Fetch job status from dbt Cloud API
            response=$(curl -s -X GET \
              -H "Authorization: Token ${{ secrets.DBT_CLOUD_API_TOKEN }}" \
              https://fa321.eu2.dbt.com/api/v2/accounts/175956220182596/runs/$run_id/)
            status_code=$(echo "$response" | jq -r '.data.status')

            # dbt Cloud status codes:
            # 1 = queued, 2 = starting, 3 = running
            # 10 = success, 20 = error, 30 = cancelled
            if [[ "$status_code" == "10" ]]; then
              echo "✅ dbt Cloud job completed successfully."
              exit 0
            elif [[ "$status_code" == "20" ]]; then
              echo "❌ dbt Cloud job failed."
              exit 1
            elif [[ "$status_code" == "30" ]]; then
              echo "⚠️ dbt Cloud job was cancelled."
              exit 1
            else
              echo "Current status: $status_code (waiting...)"
            fi

            # Check timeout
            now=$(date +%s)
            if (( now - start_time > timeout )); then
              echo "⏱️ Timeout reached after $timeout seconds."
              exit 1
            fi

            # Wait before next poll
            sleep 15
          done
